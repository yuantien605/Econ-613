---
title: "A4"
author: "Yuan Tien"
date: "4/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
rm(list = ls())
getwd()
setwd("/Users/yuantien/Desktop/R/613/A4")
library(data.table)

dat <- fread("dat_A4.csv")
```

Exercise I 

1.1
To my understanding, the latest interview is in 2019, so we compute age base on 2019 - birth year 
```{r}
dat97 <- dat %>%
  mutate(age = 2019 - KEY_BDATE_Y_1997)
dat97$expweek <- rowSums(dat97[,18:28], na.rm = T)

#Since a year has 52.1429 weeks approximately, I will divide weeks by this number
dat97$work_exp <- dat97$expweek/52.1429
```

1.2
Use YSCH-3113 to compute

GED is equivalent to 12th grade (12 years of schooling)
see:
http://usgei.org/high-school-equivalency-ged/#:~:text=GEI%20offers%20international%20students%20the,globally%20have%20earned%20GED%20diplomas.

I assume degree earned = None is 0 years of schooling
Associate degree and junior college normally takes two years. I assume they take 12+2 = 14 years of schooling 
Assume normal college degree takes 4 years (12+4 = 16) 
I assume master's degree takes additional 2 years out of college (12+4+2), and PhD takes 4 years out of college (12+ 4 +4) =20

I assume DDS, JD and MD takes 4 years out of college (12+4+4 = 20)

```{r}
s = dat97$YSCH.3113_2019
news <- recode(s, '1' = 0, "2" = 12, "3" = 12, "4" = 14, "5" = 16, "6" = 18 , "7" = 20, "8" = 20, "-1" = 0, "-2" = 0) #here I assume those refuse to answer and those who don't know their schooling as 0 year of schooling.
dat97$schooling = news

dat97$biodad_school <- dat97$CV_HGC_BIO_DAD_1997
dat97$biomom_school <- dat97$CV_HGC_BIO_MOM_1997
dat97$resdad_school <- dat97$CV_HGC_RES_DAD_1997
dat97$resmom_school <- dat97$CV_HGC_RES_MOM_1997

#I leave "Ungraded = 95" as it be for now

# dat97$biodad_school <- recode(dat97$biodad_school, "95" = 0)
# dat97$biomom_school <- recode(dat97$biomom_school, "95" = 0)
# dat97$resdad_school <- recode(dat97$resdad_school, "95" = 0)
# dat97$resmom_school <- recode(dat97$resmom_school, "95" = 0)
```

1.3.1
```{r}
#Income distribution by age group
dat97%>%
  filter(YINC_1700_2019 > 0) %>%
  ggplot(aes(x = YINC_1700_2019, color = as.factor(age))) + geom_density() 

dat97%>%
  filter(YINC_1700_2019 > 0) %>%
  ggplot(aes(x = as.factor(age), y = YINC_1700_2019, )) + geom_boxplot()
```


```{r}
dat97%>%
  filter(YINC_1700_2019 > 0) %>%
  ggplot(aes(x = YINC_1700_2019, color = as.factor(KEY_SEX_1997))) + geom_density() + labs(color = "1 = Male")

dat97%>%
  filter(YINC_1700_2019 > 0) %>%
  ggplot(aes(x = as.factor(KEY_SEX_1997), y = YINC_1700_2019)) + geom_boxplot() + xlab("1 = Male") +ylab("Income")

```

```{r}
dat97%>%
  filter(YINC_1700_2019 > 0) %>%
  filter(CV_BIO_CHILD_HH_U18_2019 >= 0) %>%
  ggplot(aes(x = as.factor(CV_BIO_CHILD_HH_U18_2019), y = YINC_1700_2019)) + geom_boxplot() + xlab("Number of children")+ylab("Income") + labs(subtitle = "Since there is nearly no obs with 8 or 9 children, the boxplots behave like this")

```

1.3.2
Income Age
```{r}
income_age <- as.data.frame.matrix(table(dat97$age, dat97$YINC_1700_2019))  
income_age$share_of_zero <- (income_age[,1])/rowSums(income_age)

tibble(age = 35:39, share_of_zero = income_age$share_of_zero)
```

Gender Income
```{r}
  income_gender <- as.data.frame.matrix(table(dat97$KEY_SEX_1997, dat97$YINC_1700_2019))  
  income_gender$share_of_zero <- (income_gender[,1])/rowSums(income_gender)

 tibble(sex = c("male", "female"), share_of_zero = income_gender$share_of_zero)
```

```{r}
income_child <- as.data.frame.matrix(table(dat97$CV_BIO_CHILD_HH_U18_2019, dat97$YINC_1700_2019))  
income_child$share_of_zero <- (income_child[,1])/rowSums(income_child)

tibble(number_of_children = 0:9, share_of_zero = income_child$share_of_zero)
```


```{r}
marry_income <- as.data.frame.matrix(table(dat97$CV_MARSTAT_COLLAPSED_2019, dat97$YINC_1700_2019))  
marry_income$share_of_zero <- (marry_income[,1])/rowSums(marry_income)

tibble(marital_status = c("Never_married", "Married", "Separated", "Divorced", "Widowed"), share_of_zero = marry_income$share_of_zero)
```
1.3.3

Interpretation

1. The age of the respondents seems not to be associated with income.
2. Male appears to earn more than female.
3. People with small family size (i.e, 1-3 children) seems to earn more than people with no children and more than 3 children.
4. 35 & 38 years old age group has more people with 0 income than other groups in proportion.
5. There are more male with 0 income than female in proportion.
6. People with less children has a larger share of people with 0 income.


Exercise II

2.1
```{r}
#Proposed model: income_i = b0+ b1 * work_experience_i + b2 * schooling_i

dat97 %>%
  filter(YINC_1700_2019 >0) %>%
  lm(YINC_1700_2019 ~ work_exp + schooling, data =.) %>%
  summary()

```

This OLS model, however, may suffer from selection problem since people who report 0 income or those that don't report income is not random. There might be ommitted variable that influence the reporting bias and also work experience and years of schooling.


Hence, we could consider Heckman's two step estimation.

2.2

Heckman's Two-Step estimator consider the selection problem by estimating the part that determines the dependent variable (here is income) but is not our explanatory variable. Using that part as a regressor for a second stage regression, we can obtain consistent estimates of x ruling out the effect of selection.

2.3 

Hung-Wei said on Slack that we can use glm() to estimate the first stage probit
```{r}
#create a dummy for income >0 

dat97$nonmiss <- ifelse(dat97$YINC_1700_2019 > 0, 1,0)

dat97$nonmiss[is.na( dat97$nonmiss ) == T] = 0 #make missing value = 0 

first <- glm(formula =  nonmiss ~ work_exp + schooling, family = binomial(link = "probit"), data = dat97)
summary(first)

first_predict <- - predict(first) #remember a negative sign

inmills <- dnorm(first_predict)/ (1- pnorm(first_predict)) #pdf/cdf
summary(inmills)

Hecloglik <- function (par, work_exp, schooling, inmills)  {
  XB   = par[1] + par[2]* work_exp + par[3]* schooling + par[4] * inmills
  Prob = dnorm(XB)
  Prob[Prob>0.999999] = 0.999999 
  Prob[Prob<0.000001] = 0.000001
  Like = log(Prob)
  return( - sum(Like) )
}
```

Use lm() to help me find good starting value
```{r}
regdat <- dat97 %>%
  filter(is.na(work_exp) == F, is.na(schooling) == F) %>%
  cbind(inmills)

cheat <- lm(YINC_1700_2019 ~ work_exp + schooling + inmills, data = regdat)
as.vector(cheat$coefficients) 

startv <- as.vector(cheat$coefficients) 
#noisestartv <- jitter(startv) #add noise
#noisestartv

work_exp = regdat$work_exp
schooling = regdat$schooling
inmills = regdat$inmills

```

```{r}
results_2stage <- optim(startv, fn = Hecloglik, method = "BFGS", 
                  control = list(trace = 6, maxit = 3000),
                  work_exp = work_exp, schooling = schooling, inmills = inmills)
results_2stage$par
```
The results change a lot. Perhaps Those that earn very little or unemployed are systematically absent from the survey, which creates overestimation using OLS.


Exercise 3

```{r}

```

