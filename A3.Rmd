---
title: "A3"
author: "Yuan Tien"
date: "3/3/2022"
output: html_document
---

```{r}
library(dplyr)
library(tidyr)
library(data.table)

getwd()
setwd("/Users/yuantien/Desktop/R/613/Data")
list.files()

datstu <- fread("datstu_v2.csv")
datsch <- fread("datsss.csv")
geo    <- fread("datjss.csv")

```

Exercise 1  
1.1
```{r}
programs <- datstu[,11:16] #select all progran choices from the dataset
programs <- unlist(programs, use.names = FALSE) #turn programs from choice 1 to choice 6 into a vector

uniprog <- unique(programs)

Num <- data.frame(no._student = nrow(datstu), 
                  no._school  = length(unique(datsch$schoolcode)),
                  no._program = length(uniprog) )
Num
```
1.2
unique school - program dyads
Can I just paste school choice with corresponding dyads and find the unique ones?
```{r}
matchoice1 <- datstu%>%
  select(schoolcode1, choicepgm1)

matchoice2 <- datstu%>%
  select(schoolcode2, choicepgm2)

matchoice3 <- datstu%>%
  select(schoolcode3, choicepgm3)

matchoice4 <- datstu%>%
  select(schoolcode4, choicepgm4)

matchoice5 <- datstu%>%
  select(schoolcode5, choicepgm5)

matchoice6 <- datstu%>%
  select(schoolcode6, choicepgm6)

#apropos() 

allchoice <- do.call("rbind", list(matchoice1, matchoice2, matchoice3, matchoice4, matchoice5, matchoice6, use.names=FALSE))

choice <- unique(allchoice)
nrow(choice) #3086 unique school - programs dyads
```

1.3
apply to schools near home
idea: write a function to determine one person at a time, and then sapply to all people

```{r}
schdis <- datsch %>%
  select(schoolcode, sssdistrict)
schdis <- schdis[!duplicated(schdis$schoolcode),] #This is a list of schools with corresponding district

#Right now I can join the school dataset 

applyhome <- function(x) {
  one <- datstu[x,c(5:10, 17)] #take the person's school choice and home district
  onelong <- pivot_longer(one, !jssdistrict, values_to = "schoolcode")
  onelong <- onelong %>%
    select(jssdistrict, schoolcode)
  onet <- onelong %>%
    left_join(schdis, by = "schoolcode")
  sum(onet$jssdistrict == onet$sssdistrict)
} 

totapphome <- sapply(1:nrow(datstu), applyhome) #This takes a lot of time
length (totapphome) 
x <- totapphome >= 1 #Since the number indicates how many schools applied are in the home district, >1 captures all cases that match the question 
table(x) #250806 individuals apply to at least a school in his/her home district

#Or, maybe I can replace all schoolcode with corresponding location 2. and then just look at whether one of the 6 locations equal the jssdistrict
```

1.4

```{r}

#I calculate the number of schools admitted students by their rank. For example, to calculate how many students Duke admitted, I add up the number of students get admitted when Duke is their 1st - 6th choice.

try <- datstu %>%
  select(c(5:10,18)) 

try$admit_1 <- ifelse(try$rankplace == 1, try$schoolcode1, 0)
ch1 <- count(try, admin = admit_1) #first choices

try$admit_2 <- ifelse(try$rankplace == 2, try$schoolcode1, 0)
ch2 <- count(try, admin = admit_2) 

try$admit_3 <- ifelse(try$rankplace == 3, try$schoolcode1, 0)
ch3 <- count(try, admin = admit_3) 

try$admit_4 <- ifelse(try$rankplace == 4, try$schoolcode1, 0)
ch4 <- count(try, admin = admit_4) 

try$admit_5 <- ifelse(try$rankplace == 5, try$schoolcode1, 0)
ch5 <- count(try, admin = admit_5) 

try$admit_6 <- ifelse(try$rankplace == 6, try$schoolcode1, 0)
ch6 <- count(try, admin = admit_6) 

school_admin <- bind_rows(ch1, ch2, ch3, ch4, ch5, ch6) %>%
  group_by(admin) %>%
  summarise( sum(n) )

colnames(school_admin) <- c("schoolcode", "admitted number of students")

schoolist <- datsch %>%
  filter(duplicated(schoolcode) == FALSE) %>%
  select(schoolcode, schoolname) %>%
  left_join(school_admin, by = "schoolcode")

schoolist #NA represents no admission
```

1.5
To calculate the cutoff of each senior high schools and later on the quality of senior high, I will first create a column showing the student's admitted school.

I use my "try" dataframe I created earlier to do this. The try dataframe has six separate columns (for 6 school choices) showing each student's admitted school's school code. If Mike is admitted to his 3rd dream school of schoolcode 98021, the admit_3 column will show "98021" while admit_1, admit_2....will show 0.

```{r}
admit <- try[,8:13] #select admit_1 to admit_6
admit$admit_school = rowSums(admit) 
#Since columns outside of student's admitted school's rank will show 0, by adding all the columns I get the school they are admitted to

datstu_ad <- cbind(datstu, admit_school = admit$admit_school)

datstu_ad %>%
  group_by(admit_school) %>%
  summarise(min(score))  #Note that school "0" indicates a pool of people who didn't get admitted to any senior high schools 
```
1.6

```{r}
datstu_ad %>%
  group_by(admit_school) %>%
  summarise( mean(score) )


```

Exercise 2 - Data

```{r}

```

